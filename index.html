<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Controle de Acordos de Cooperação Técnica e Convênios</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<style>
:root{--card:#fff;--border:#e7e7e7;--muted:#666;--bg:#fafafa;}
body{font-family:Arial;margin:18px 24px;background:var(--bg);}
.layout{display:flex;gap:14px}
.sidebar{width:260px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
.field{margin:10px 0}
.select,.btn{width:100%;padding:8px;border-radius:8px;border:1px solid #ccc}
.btn{cursor:pointer;background:#f5f5f5}
.btn.active{background:#111;color:#fff;border-color:#111}
.main{flex:1}
.cards{display:flex;gap:12px;margin-bottom:18px}
.card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;min-width:200px}
.card .value{font-size:26px;font-weight:700}
.panel{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:14px}
#chart_status,#chart_venc{height:320px}
</style>
</head>

<body>

<div class="layout">

<aside class="sidebar">
<h4>Filtros</h4>

<div class="field">
<select id="filterStatus" class="select">
<option value="">Todos</option>
<option value="VIGENTE">VIGENTE</option>
<option value="ALERTA 180 DIAS">ALERTA 180 DIAS</option>
<option value="ARQUIVADO">ARQUIVADO</option>
</select>
</div>

<div class="field">
<button id="resetFilters" class="btn">Ver todos</button>
</div>

<div class="field">
<button id="btnConcluidos" class="btn">ACTs concluídos</button>
</div>

</aside>

<main class="main">

<div class="cards">
<div class="card">
<div>Total</div>
<div class="value" id="kpi_total">—</div>
</div>

<div class="card">
<div>Vigentes</div>
<div class="value" id="kpi_vigentes">—</div>
</div>

<div class="card">
<div>Alerta (≤180 dias)</div>
<div class="value" id="kpi_alerta">—</div>
</div>
</div>

<div class="panel">
<h3>Status de vigência</h3>
<div id="chart_status"></div>
</div>

<div class="panel">
<h3>Vencimentos por mês</h3>
<div id="chart_venc"></div>
</div>

</main>
</div>

<script>
const CSV_URL="./data/tbl_instrumentos.csv";
let tbl=[];

function parseDate(raw){
if(!raw)return null;
const d=new Date(raw);
return isNaN(d)?null:d;
}

function computeStatus(r){
if((r.status||"").toUpperCase().includes("ARQUIV"))return"ARQUIVADO";
const d=parseDate(r.vigencia_termino);
if(!d)return null;
const diff=(d-new Date())/(1000*60*60*24);
if(diff<=180)return"ALERTA 180 DIAS";
return"VIGENTE";
}

function updateKPIs(rows){
const base=rows.filter(r=>computeStatus(r)!=="ARQUIVADO");
const vig=base.filter(r=>computeStatus(r)==="VIGENTE").length;
const alt=base.filter(r=>computeStatus(r)==="ALERTA 180 DIAS").length;

document.getElementById("kpi_total").textContent=base.length;
document.getElementById("kpi_vigentes").textContent=vig;
document.getElementById("kpi_alerta").textContent=alt;
}

function buildStatus(rows){
const base=rows.filter(r=>computeStatus(r)!=="ARQUIVADO");
const vig=base.filter(r=>computeStatus(r)==="VIGENTE").length;
const alt=base.filter(r=>computeStatus(r)==="ALERTA 180 DIAS").length;

Plotly.newPlot("chart_status",[{
type:"pie",
labels:["VIGENTE","ALERTA 180 DIAS"],
values:[vig,alt],
hole:.55,
marker:{colors:["#16a34a","#f59e0b"]},
textinfo:"value+percent"
}],{margin:{t:10}});
}

function buildVenc(rows){
const base=rows.filter(r=>computeStatus(r)!=="ARQUIVADO");
const months={};

base.forEach(r=>{
const d=parseDate(r.vigencia_termino);
if(!d)return;
const key=d.getMonth()+1+"/"+d.getFullYear();
months[key]=(months[key]||0)+1;
});

const labels=Object.keys(months);
const values=Object.values(months);

Plotly.newPlot("chart_venc",[{
type:"bar",
x:labels,
y:values,
marker:{color:"#111"}
}],{margin:{t:10}});
}

function applyFilters(){
const status=document.getElementById("filterStatus").value;
let rows=tbl;
if(status)rows=rows.filter(r=>computeStatus(r)===status);
updateKPIs(rows);
buildStatus(rows);
buildVenc(rows);
}

document.getElementById("resetFilters").addEventListener("click",()=>{
document.getElementById("filterStatus").value="";
applyFilters();
});

document.getElementById("btnConcluidos").addEventListener("click",()=>{
document.getElementById("filterStatus").value="ARQUIVADO";
applyFilters();
});

document.getElementById("filterStatus").addEventListener("change",applyFilters);

Papa.parse(CSV_URL,{
download:true,
header:true,
complete:function(res){
tbl=res.data.filter(r=>Object.values(r).some(v=>v));
applyFilters();
}
});
</script>

</body>
</html>
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle de Acordos de Cooperação Técnica e Convênios</title>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <!-- PapaParse (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 1px 2px rgba(0,0,0,.06);
      --radius:12px;
      --pad:14px;
      --btn:#f3f4f6;
      --btnBorder:#d1d5db;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:var(--bg);
    }

    .layout{
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:16px;
      padding:16px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Sidebar */
    .sidebar{
      position: sticky;
      top:16px;
      align-self:start;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:var(--pad);
    }

    .card + .card{ margin-top:12px; }

    .sidebar h3{
      margin:0 0 10px 0;
      font-size:14px;
      font-weight:700;
    }

    label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin:10px 0 6px;
    }

    select, input[type="text"]{
      width:100%;
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      font-size:13px;
      background:#fff;
    }

    .btn{
      border:1px solid var(--btnBorder);
      background:var(--btn);
      border-radius:10px;
      padding:8px 10px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }

    .btnWide{
      width:100%;
      margin-top:10px;
    }

    /* Header */
    .header{
      grid-column: 1 / -1;
      display:flex;
      align-items:center;
      gap:14px;
      padding:14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 220px;
    }
    .brand img{
      height:48px;
      width:auto;
      display:block;
    }

    .titleBlock{
      flex:1;
      min-width: 0;
    }
    .titleBlock h1{
      margin:0;
      font-size:26px;
      line-height:1.15;
      letter-spacing:.1px;
    }
    .titleBlock p{
      margin:4px 0 0;
      color:var(--muted);
      font-size:13px;
    }

    /* Main */
    .main{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
    }

    .kpi{
      padding:14px;
    }
    .kpi .label{
      color:var(--muted);
      font-size:12px;
      margin:0 0 6px;
    }
    .kpi .value{
      font-size:28px;
      font-weight:800;
      margin:0;
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .panel h3{
      margin:0 0 10px;
      font-size:16px;
      font-weight:800;
    }

    .legendBox{
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
      font-size:12px;
      color:#111827;
      background:#fbfbfc;
    }

    .muted{ color:var(--muted); font-size:12px; }

    .toolbar{
      display:flex;
      gap:10px;
      margin-top:10px;
      align-items:center;
    }

    /* Table */
    .tableWrap{
      margin-top:10px;
    }
    .table-scroll{
      overflow:auto;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 1100px;
      font-size:13px;
    }
    thead th{
      position:sticky;
      top:0;
      background:#f9fafb;
      border-bottom:1px solid var(--border);
      padding:10px 10px;
      text-align:left;
      font-size:12px;
      color:#111827;
      white-space:nowrap;
      z-index:1;
    }
    tbody td{
      border-bottom:1px solid var(--border);
      padding:10px 10px;
      vertical-align:top;
    }
    tbody tr:hover td{
      background:#fcfcfd;
    }

    /* Processo: dá mais “respiro” e evita esmagar */
    th.col-proc, td.col-proc{
      min-width: 170px;
      max-width: 240px;
      white-space: normal;
      word-break: break-word;
    }

    /* Details row */
    .detailsRow td{
      background:#fafafa;
      border-bottom:1px solid var(--border);
      padding:12px 10px;
    }
    .detailsGrid{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:8px 12px;
      font-size:12px;
    }
    .detailsGrid .k{
      color:#374151;
      font-weight:700;
    }
    .detailsGrid .v{
      color:#111827;
    }

    /* Modal */
    .modalBackdrop{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      z-index:50;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(720px, 100%);
      background:#fff;
      border-radius:12px;
      border:1px solid var(--border);
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      padding:14px;
    }
    .modalHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .modalHeader h4{
      margin:0;
      font-size:14px;
      font-weight:800;
    }
    .modalBody{
      max-height: 60vh;
      overflow:auto;
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
      background:#fbfbfc;
      font-size:13px;
    }
    .modalBody ul{ margin:6px 0 0; padding-left:18px; }
    .modalBody li{ margin:4px 0; }

    /* Details (organizacional) */
    details summary.btn{
      list-style:none;
      display:inline-block;
    }
    details summary.btn::-webkit-details-marker{ display:none; }

    @media (max-width: 1080px){
      .layout{ grid-template-columns: 1fr; }
      .sidebar{ position:static; }
      .kpis{ grid-template-columns: 1fr; }
      .row2{ grid-template-columns: 1fr; }
      table{ min-width: 980px; }
    }
  </style>
</head>

<body>
  <div class="layout">

    <!-- HEADER -->
    <div class="card header">
      <div class="brand">
        <!-- Se você já usa suas imagens/logos localmente, ajuste os src -->
        <img src="logo_fvs.png" alt="FVS" onerror="this.style.display='none'">
        <img src="logo_depi.png" alt="DEPI" onerror="this.style.display='none'">
      </div>

      <div class="titleBlock">
        <div class="muted" style="margin-bottom:4px;">FVS-RCP • DEPI</div>
        <h1>Controle de Acordos de Cooperação Técnica e Convênios</h1>
        <p>Painel de monitoramento de vigência e renovação</p>
      </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="sidebar">

      <div class="card">
        <h3>Filtros</h3>

        <label for="f_ano">Ano de vencimento</label>
        <select id="f_ano">
          <option value="__ALL__">Todos</option>
        </select>

        <label for="f_tipo">Tipo</label>
        <select id="f_tipo">
          <option value="__ALL__">Todos</option>
        </select>

        <label for="f_inst">Instituição</label>
        <select id="f_inst">
          <option value="__ALL__">Todas</option>
        </select>

        <label for="f_uf">UF</label>
        <select id="f_uf">
          <option value="__ALL__">Todas</option>
        </select>

        <label for="f_status">Status</label>
        <select id="f_status">
          <option value="__ALL__">Todos</option>
          <!-- NÃO inclui ARQUIVADO -->
          <option value="VIGENTE">VIGENTE</option>
          <option value="ALERTA 180 DIAS">ALERTA 180 DIAS</option>
          <option value="SEM DATA">SEM DATA</option>
        </select>

        <button id="btn_ver_todos" class="btn btnWide">Ver todos</button>
      </div>

      <!-- KPI sidebar: concluídos -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div class="muted" style="font-size:12px;">ACTs concluídos</div>
          <div id="kpi_concl_sidebar" style="font-weight:800; font-size:18px;">—</div>
        </div>
        <button id="btn_ver_concl_insts" class="btn" style="margin-top:10px;">Ver instituições</button>
      </div>

    </aside>

    <!-- MAIN -->
    <main class="main">

      <!-- KPIs (somente 3, como você pediu) -->
      <section class="kpis">
        <div class="card kpi">
          <p class="label">Total</p>
          <p id="kpi_total" class="value">—</p>
        </div>

        <div class="card kpi">
          <p class="label">Vigentes</p>
          <p id="kpi_vigentes" class="value">—</p>
        </div>

        <div class="card kpi">
          <p class="label">Alerta (≤180 dias)</p>
          <p id="kpi_alerta" class="value">—</p>
        </div>
      </section>

      <!-- Charts row 1 -->
      <section class="row2">
        <div class="card panel">
          <h3>Status de vigência</h3>
          <div id="chart_status" style="height:320px;"></div>
          <div class="muted" style="margin-top:8px;">
            <span style="display:inline-flex;align-items:center;gap:6px;margin-right:10px;">
              <span style="width:10px;height:10px;border-radius:2px;background:#16a34a;display:inline-block;"></span> VIGENTE
            </span>
            <span style="display:inline-flex;align-items:center;gap:6px;margin-right:10px;">
              <span style="width:10px;height:10px;border-radius:2px;background:#f59e0b;display:inline-block;"></span> ALERTA 180 DIAS
            </span>
            <span style="display:inline-flex;align-items:center;gap:6px;">
              <span style="width:10px;height:10px;border-radius:2px;background:#9ca3af;display:inline-block;"></span> SEM DATA
            </span>
          </div>
        </div>

        <div class="card panel">
          <h3>Vencimentos por mês</h3>
          <div class="muted" style="margin:0 0 6px;">
            <span style="display:inline-flex;align-items:center;gap:6px;margin-right:10px;">
              <span style="width:10px;height:10px;border-radius:2px;background:#c0392b;display:inline-block;"></span> &lt; 1 ano (crítico)
            </span>
            <span style="display:inline-flex;align-items:center;gap:6px;margin-right:10px;">
              <span style="width:10px;height:10px;border-radius:2px;background:#f39c12;display:inline-block;"></span> 1–2 anos (atenção)
            </span>
            <span style="display:inline-flex;align-items:center;gap:6px;margin-right:10px;">
              <span style="width:10px;height:10px;border-radius:2px;background:#2ecc71;display:inline-block;"></span> &gt; 2 anos (vigência confortável)
            </span>
            <span style="display:inline-flex;align-items:center;gap:6px;">
              <span style="width:10px;height:10px;border-radius:2px;background:#9ca3af;display:inline-block;"></span> Sem data
            </span>
          </div>
          <div id="chart_venc" style="height:320px;"></div>
        </div>
      </section>

      <!-- Charts row 2 (MAPA + DIRETORIAS lado a lado) -->
      <section class="row2">
        <div class="card panel">
          <h3>Mapa (parcerias por UF)</h3>
          <div id="chart_mapa" style="height:320px;"></div>
        </div>

        <div class="card panel">
          <h3>Diretorias responsáveis (quantitativo)</h3>
          <div id="chart_dir" style="height:320px;"></div>
        </div>
      </section>

      <!-- Table -->
      <section class="card panel">
        <h3>Instrumentos</h3>

        <div class="legendBox">
          <strong>Legenda</strong><br>
          <span><strong>ACT</strong> = Acordo de Cooperação Técnica</span><br>
          <span><strong>Convênio</strong> = Convênio</span><br>
          <span><strong>TC</strong> = Termo de Colaboração</span>
        </div>

        <details style="margin-top:10px;">
          <summary class="btn" style="display:inline-block; user-select:none;">
            Ver estrutura organizacional
          </summary>

          <div class="legendBox" style="margin-top:10px; width:100%;">
            <strong>Diretorias</strong><br>
            <span><strong>DEPI</strong> – Diretoria de Ensino, Pesquisa e Inovação</span><br>
            <span><strong>DVACD</strong> – Diretoria de Vigilância Ambiental e Controle de Doenças</span><br>
            <span><strong>DVE</strong> – Diretoria de Vigilância Epidemiológica</span><br>
            <span><strong>LACEN</strong> – Laboratório Público Central</span><br><br>

            <strong>Gerências</strong><br>
            <span><strong>GPAVS</strong> – Gerência de Pesquisa Aplicada a Vigilância em Saúde</span><br>
            <span><strong>SGENTO</strong> – Subgerência de Entomologia</span><br>
            <span><strong>SASS</strong> – Sala de Análise de Situação de Saúde</span>
          </div>
        </details>

        <div class="toolbar">
          <input id="search" type="text" placeholder="Buscar (identificação, instituição, processo, status...)" />
        </div>

        <div class="tableWrap">
          <div class="table-scroll">
            <table id="tbl">
              <thead>
                <tr>
                  <th>Identificação</th>
                  <th>Tipo</th>
                  <th>Instituição</th>
                  <th>Diretoria</th>
                  <th>Gerência</th>
                  <th>Status</th>
                  <th>Início</th>
                  <th>Vencimento</th>
                  <th>Aditivos</th>
                  <th class="col-proc">Processo</th>
                  <th>Detalhes</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Modal concluídos -->
  <div id="modalBackdrop" class="modalBackdrop">
    <div class="modal">
      <div class="modalHeader">
        <h4>Instituições com ACTs concluídos</h4>
        <button id="btnModalClose" class="btn">Fechar</button>
      </div>
      <div id="modalBody" class="modalBody"></div>
    </div>
  </div>

  <script>
    // =========================
    // Helpers
    // =========================
    function escapeHTML(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normKey(k){
      return String(k || "")
        .trim()
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // remove acentos
        .replace(/\s+/g, "_");
    }

    function getFirst(row, keys){
      for(const k of keys){
        const kk = normKey(k);
        if(kk in row && row[kk] !== undefined && row[kk] !== null && String(row[kk]).trim() !== ""){
          return row[kk];
        }
      }
      return "";
    }

    function parseBRDate(s){
      // aceita dd/mm/yyyy ou yyyy-mm-dd
      const str = String(s || "").trim();
      if(!str) return null;

      // dd/mm/yyyy
      const m1 = str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if(m1){
        const d = Number(m1[1]), mo = Number(m1[2]) - 1, y = Number(m1[3]);
        const dt = new Date(y, mo, d);
        return isNaN(dt) ? null : dt;
      }

      // yyyy-mm-dd
      const m2 = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(m2){
        const y = Number(m2[1]), mo = Number(m2[2]) - 1, d = Number(m2[3]);
        const dt = new Date(y, mo, d);
        return isNaN(dt) ? null : dt;
      }

      return null;
    }

    function fmtMonthYear(dt){
      const meses = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
      return `${meses[dt.getMonth()]} de ${dt.getFullYear()}`;
    }

    // =========================
    // Status (vigência)
    // =========================
    function computeStatus(row){
      // Arquivado (mesmo sem aparecer no filtro, o painel ignora)
      const sExec = String(getFirst(row, ["status", "situacao", "situação", "status_execucao", "status_execução"]) || "").toUpperCase();
      if(sExec.includes("ARQUIV")) return "ARQUIVADO";

      const vencRaw = getFirst(row, ["vencimento", "data_vencimento", "fim", "termino", "término"]);
      const venc = parseBRDate(vencRaw);

      if(!venc) return "SEM DATA";

      const hoje = new Date();
      const diffDays = Math.ceil((venc - hoje) / (1000*60*60*24));
      if(diffDays <= 180) return "ALERTA 180 DIAS";
      return "VIGENTE";
    }

    // =========================
    // CSV load
    // =========================
    async function loadCSV(){
      const res = await fetch("tbl_instrumentos.csv", { cache: "no-store" });
      const text = await res.text();

      const parsed = Papa.parse(text, {
        header:true,
        skipEmptyLines:true
      });

      // normaliza chaves
      const rows = (parsed.data || []).map(obj => {
        const out = {};
        for(const [k,v] of Object.entries(obj)){
          out[normKey(k)] = (v ?? "").toString().trim();
        }
        return out;
      });

      return rows;
    }

    // =========================
    // Elements
    // =========================
    const kpi_total = document.getElementById("kpi_total");
    const kpi_vigentes = document.getElementById("kpi_vigentes");
    const kpi_alerta = document.getElementById("kpi_alerta");

    const f_ano = document.getElementById("f_ano");
    const f_tipo = document.getElementById("f_tipo");
    const f_inst = document.getElementById("f_inst");
    const f_uf = document.getElementById("f_uf");
    const f_status = document.getElementById("f_status");

    const btn_ver_todos = document.getElementById("btn_ver_todos");
    const search = document.getElementById("search");
    const tbody = document.getElementById("tbody");

    // Sidebar concluídos
    const kpi_concl_sidebar = document.getElementById("kpi_concl_sidebar");
    const btn_ver_concl_insts = document.getElementById("btn_ver_concl_insts");

    // Modal
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalBody = document.getElementById("modalBody");
    const btnModalClose = document.getElementById("btnModalClose");

    // =========================
    // Data state
    // =========================
    let ALL = [];
    let FILTERED = [];

    // =========================
    // Filters setup
    // =========================
    function uniqSorted(arr){
      return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b, "pt-BR"));
    }

    function fillSelect(selectEl, values, allLabel){
      const cur = selectEl.value;
      selectEl.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "__ALL__";
      optAll.textContent = allLabel;
      selectEl.appendChild(optAll);

      values.forEach(v=>{
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        selectEl.appendChild(opt);
      });

      // tenta manter seleção
      if(Array.from(selectEl.options).some(o=>o.value === cur)){
        selectEl.value = cur;
      }
    }

    function rebuildFilterOptions(baseRows){
      // baseRows já vem SEM ARQUIVADOS
      const anos = uniqSorted(baseRows.map(r=>{
        const venc = parseBRDate(getFirst(r, ["vencimento","data_vencimento","fim","termino","término"]));
        return venc ? String(venc.getFullYear()) : "";
      }));

      const tipos = uniqSorted(baseRows.map(r=>String(getFirst(r, ["tipo","instrumento"]) || "").trim()));
      const insts = uniqSorted(baseRows.map(r=>String(getFirst(r, ["instituicao_parceira","instituicao","instituicao_parceira_nome"]) || "").trim()));
      const ufs = uniqSorted(baseRows.map(r=>String(getFirst(r, ["uf","estado","estado_parceiro"]) || "").trim()));

      fillSelect(f_ano, anos, "Todos");
      fillSelect(f_tipo, tipos, "Todos");
      fillSelect(f_inst, insts, "Todas");
      fillSelect(f_uf, ufs, "Todas");
      // status já tem opções fixas (sem ARQUIVADO)
    }

    // =========================
    // Apply filters
    // =========================
    function applyFilters(){
      const ano = f_ano.value;
      const tipo = f_tipo.value;
      const inst = f_inst.value;
      const uf = f_uf.value;
      const st = f_status.value;
      const q = (search.value || "").trim().toLowerCase();

      // SEMPRE ignora ARQUIVADOS no painel
      let rows = ALL.filter(r => computeStatus(r) !== "ARQUIVADO");

      rows = rows.filter(r=>{
        // ano
        if(ano !== "__ALL__"){
          const venc = parseBRDate(getFirst(r, ["vencimento","data_vencimento","fim","termino","término"]));
          const y = venc ? String(venc.getFullYear()) : "";
          if(y !== ano) return false;
        }
        // tipo
        if(tipo !== "__ALL__"){
          const t = String(getFirst(r, ["tipo","instrumento"]) || "");
          if(t !== tipo) return false;
        }
        // inst
        if(inst !== "__ALL__"){
          const i = String(getFirst(r, ["instituicao_parceira","instituicao","instituicao_parceira_nome"]) || "");
          if(i !== inst) return false;
        }
        // uf
        if(uf !== "__ALL__"){
          const u = String(getFirst(r, ["uf","estado","estado_parceiro"]) || "");
          if(u !== uf) return false;
        }
        // status (vigência)
        if(st !== "__ALL__"){
          if(computeStatus(r) !== st) return false;
        }
        // busca livre
        if(q){
          const blob = [
            getFirst(r, ["identificacao","identificação","id","numero","número"]),
            getFirst(r, ["tipo","instrumento"]),
            getFirst(r, ["instituicao_parceira","instituicao","instituicao_parceira_nome"]),
            getFirst(r, ["diretoria_responsavel","diretoria","setor","setor_responsavel"]),
            getFirst(r, ["gerencia_responsavel","gerencia","gerência"]),
            computeStatus(r),
            getFirst(r, ["numero_processo","processo","n_processo","numero_do_processo"]),
          ].join(" ").toLowerCase();

          if(!blob.includes(q)) return false;
        }
        return true;
      });

      FILTERED = rows;

      updateKPIs(rows);
      buildStatusDonut(rows);
      buildVencimentos(rows);
      buildMapa(rows);
      buildDiretorias(rows);
      renderTable(rows);

      updateConcluidosSidebar(rows);
    }

    // =========================
    // KPIs (somente 3)
    // =========================
    function updateKPIs(rows){
      const counts = { "VIGENTE":0, "ALERTA 180 DIAS":0, "SEM DATA":0 };
      rows.forEach(r => { counts[computeStatus(r)]++; });

      kpi_total.textContent = rows.length;
      kpi_vigentes.textContent = counts["VIGENTE"];
      kpi_alerta.textContent = counts["ALERTA 180 DIAS"];
    }

    // =========================
    // Donut Status
    // =========================
    function buildStatusDonut(rows){
      const counts = { "VIGENTE":0, "ALERTA 180 DIAS":0, "SEM DATA":0 };
      rows.forEach(r => { counts[computeStatus(r)]++; });

      Plotly.newPlot("chart_status", [{
        type:"pie",
        labels:["VIGENTE","ALERTA 180 DIAS","SEM DATA"],
        values:[counts["VIGENTE"], counts["ALERTA 180 DIAS"], counts["SEM DATA"]],
        hole:.55,
        textinfo:"none",
        texttemplate:"<b>%{value}</b><br><b>%{percent}</b>",
        textposition:"inside",
        marker:{
          colors:["#16a34a","#f59e0b","#9ca3af"],
          line:{ color:"#ffffff", width:3 }
        },
        sort:false,
        showlegend:false
      }], {
        height:320,
        margin:{t:10,r:10,b:10,l:10}
      }, { displayModeBar:false, responsive:true });
    }

    // =========================
    // Vencimentos por mês (barras)
    // =========================
    function buildVencimentos(rows){
      // agrupa por mês/ano de vencimento
      const hoje = new Date();
      const buckets = new Map(); // label -> {critico, atencao, confortavel, semdata}

      for(const r of rows){
        const venc = parseBRDate(getFirst(r, ["vencimento","data_vencimento","fim","termino","término"]));
        if(!venc){
          const key = "Sem data";
          if(!buckets.has(key)) buckets.set(key, {critico:0, atencao:0, confortavel:0, semdata:0, dt:null});
          buckets.get(key).semdata++;
          continue;
        }

        const key = fmtMonthYear(venc);
        if(!buckets.has(key)) buckets.set(key, {critico:0, atencao:0, confortavel:0, semdata:0, dt:venc});

        const diffDays = Math.ceil((venc - hoje)/(1000*60*60*24));
        const diffYears = diffDays / 365.25;

        if(diffDays <= 0){
          buckets.get(key).critico++; // vencido: trata como crítico
        } else if(diffYears < 1){
          buckets.get(key).critico++;
        } else if(diffYears <= 2){
          buckets.get(key).atencao++;
        } else {
          buckets.get(key).confortavel++;
        }
      }

      // ordena por data, deixando "Sem data" por último
      const entries = Array.from(buckets.entries()).sort((a,b)=>{
        if(a[0] === "Sem data") return 1;
        if(b[0] === "Sem data") return -1;
        return (a[1].dt - b[1].dt);
      });

      const x = entries.map(e=>e[0]);
      const crit = entries.map(e=>e[1].critico);
      const aten = entries.map(e=>e[1].atencao);
      const conf = entries.map(e=>e[1].confortavel);
      const semd = entries.map(e=>e[1].semdata);

      Plotly.newPlot("chart_venc", [
        { type:"bar", x, y:crit, name:"< 1 ano (crítico)", marker:{ color:"#c0392b" } },
        { type:"bar", x, y:aten, name:"1–2 anos (atenção)", marker:{ color:"#f39c12" } },
        { type:"bar", x, y:conf, name:"> 2 anos (vigência confortável)", marker:{ color:"#2ecc71" } },
        { type:"bar", x, y:semd, name:"Sem data", marker:{ color:"#9ca3af" } }
      ], {
        barmode:"stack",
        height:320,
        margin:{t:10,r:10,b:70,l:40},
        xaxis:{ tickangle:-45, automargin:true },
        yaxis:{ title:"Quantidade", rangemode:"tozero" },
        legend:{ orientation:"h", y:-0.25 }
      }, { displayModeBar:false, responsive:true });
    }

    // =========================
    // Mapa (parcerias por UF)
    // =========================
    const UF_COORD = {
      "AC": [-9.97499, -67.8243],
      "AL": [-9.66599, -35.735],
      "AP": [0.03493, -51.0694],
      "AM": [-3.11903, -60.0217],
      "BA": [-12.9714, -38.5014],
      "CE": [-3.73186, -38.5267],
      "DF": [-15.7939, -47.8828],
      "ES": [-20.3155, -40.3128],
      "GO": [-16.6869, -49.2648],
      "MA": [-2.53073, -44.3068],
      "MT": [-15.601, -56.0974],
      "MS": [-20.4697, -54.6201],
      "MG": [-19.9167, -43.9345],
      "PA": [-1.45502, -48.5024],
      "PB": [-7.11509, -34.8641],
      "PR": [-25.4284, -49.2733],
      "PE": [-8.04756, -34.877],
      "PI": [-5.08921, -42.8016],
      "RJ": [-22.9068, -43.1729],
      "RN": [-5.79448, -35.211],
      "RS": [-30.0346, -51.2177],
      "RO": [-8.76077, -63.8999],
      "RR": [2.82384, -60.6753],
      "SC": [-27.5954, -48.548],
      "SP": [-23.5505, -46.6333],
      "SE": [-10.9472, -37.0731],
      "TO": [-10.184, -48.3336]
    };

    function buildMapa(rows){
      const counts = {};
      rows.forEach(r=>{
        const uf = String(getFirst(r, ["uf","estado","estado_parceiro"]) || "").trim().toUpperCase();
        if(!uf) return;
        counts[uf] = (counts[uf] || 0) + 1;
      });

      const ufs = Object.keys(counts).filter(uf => UF_COORD[uf]);
      const lats = ufs.map(uf => UF_COORD[uf][0]);
      const lons = ufs.map(uf => UF_COORD[uf][1]);
      const text = ufs.map(uf => `${uf}: ${counts[uf]}`);

      Plotly.newPlot("chart_mapa", [{
        type:"scattergeo",
        mode:"markers",
        lat:lats,
        lon:lons,
        text:text,
        hoverinfo:"text",
        marker:{
          size: ufs.map(uf => 10 + Math.min(20, counts[uf]*3)),
          color:"#111827",
          opacity:0.75,
          line:{ color:"#ffffff", width:2 }
        }
      }], {
        height:320,
        margin:{t:0,r:0,b:0,l:0},
        geo:{
          scope:"south america",
          projection:{ type:"mercator" },
          showland:true,
          landcolor:"#f3f4f6",
          showcountries:true,
          countrycolor:"#d1d5db",
          coastlinecolor:"#d1d5db",
          lataxis:{ range:[-35, 6] },
          lonaxis:{ range:[-75, -30] }
        }
      }, { displayModeBar:false, responsive:true });
    }

    // =========================
    // Diretorias (barra horizontal)
    // =========================
    function buildDiretorias(rows){
      const counts = {};
      rows.forEach(r=>{
        const d = String(getFirst(r, ["diretoria_responsavel","diretoria","setor","setor_responsavel"]) || "").trim();
        if(!d) return;
        counts[d] = (counts[d] || 0) + 1;
      });

      const labels = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]);
      const values = labels.map(l=>counts[l]);

      Plotly.newPlot("chart_dir", [{
        type:"bar",
        x:values,
        y:labels,
        orientation:"h",
        marker:{ color:"#6b7280" },
        text:values,
        textposition:"outside",
        cliponaxis:false
      }],{
        height:320,
        margin:{t:10,r:20,b:40,l:90},
        xaxis:{ title:"Quantidade", rangemode:"tozero" }
      }, { displayModeBar:false, responsive:true });
    }

    // =========================
    // Table
    // =========================
    function renderTable(rows){
      tbody.innerHTML = "";

      rows.forEach((r, idx)=>{
        const ident = getFirst(r, ["identificacao","identificação","id","numero","número"]);
        const tipo = getFirst(r, ["tipo","instrumento"]);
        const inst = getFirst(r, ["instituicao_parceira","instituicao","instituicao_parceira_nome"]);
        const dir  = getFirst(r, ["diretoria_responsavel","diretoria","setor","setor_responsavel"]);
        const ger  = getFirst(r, ["gerencia_responsavel","gerencia","gerência"]);
        const stat = computeStatus(r);
        const inicio = getFirst(r, ["inicio","data_inicio","assinatura","data_assinatura"]);
        const venc = getFirst(r, ["vencimento","data_vencimento","fim","termino","término"]);
        const adit = String(getFirst(r, ["aditivos","aditivo"]) || "").trim();
        const aditivosLabel = (adit.toUpperCase() === "SIM") ? "SIM" : "NÃO";
        const proc = getFirst(r, ["numero_processo","processo","n_processo","numero_do_processo"]);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHTML(ident || "—")}</td>
          <td>${escapeHTML(tipo || "—")}</td>
          <td>${escapeHTML(inst || "—")}</td>
          <td>${escapeHTML(dir || "—")}</td>
          <td>${escapeHTML(ger || "—")}</td>
          <td>${escapeHTML(stat || "—")}</td>
          <td>${escapeHTML(inicio || "—")}</td>
          <td>${escapeHTML(venc || "—")}</td>
          <td>${escapeHTML(aditivosLabel || "NÃO")}</td>
          <td class="col-proc">${escapeHTML(proc || "—")}</td>
          <td><button class="btn" data-i="${idx}">Ver</button></td>
        `;
        tbody.appendChild(tr);

        // details row (hidden)
        const tr2 = document.createElement("tr");
        tr2.className = "detailsRow";
        tr2.style.display = "none";
        tr2.innerHTML = `
          <td colspan="11">
            <div class="detailsGrid">
              <div class="k">Coord. parceiro:</div><div class="v">${escapeHTML(getFirst(r, ["coord_parceiro","coordenador_parceiro","responsavel_parceiro","email_parceiro"]) || "—")}</div>
              <div class="k">Resp. FVS:</div><div class="v">${escapeHTML(getFirst(r, ["resp_fvs","responsavel_fvs","responsavel_interno"]) || "—")}</div>
              <div class="k">Repasse:</div><div class="v">${escapeHTML(getFirst(r, ["repasse","repasse_financeiro"]) || "—")}</div>
              <div class="k">Estado/UF:</div><div class="v">${escapeHTML(getFirst(r, ["uf","estado","estado_parceiro"]) || "—")}</div>
              <div class="k">Publicação DOE:</div><div class="v">${escapeHTML(getFirst(r, ["publicacao_doe","publicacao","doe"]) || "—")}</div>
              <div class="k">Observações:</div><div class="v">${escapeHTML(getFirst(r, ["observacoes","observações","obs"]) || "—")}</div>
            </div>
          </td>
        `;
        tbody.appendChild(tr2);
      });

      // bind buttons
      tbody.querySelectorAll("button[data-i]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const tr = btn.closest("tr");
          const tr2 = tr.nextElementSibling;
          const open = tr2.style.display !== "none";
          tr2.style.display = open ? "none" : "table-row";
          btn.textContent = open ? "Ver" : "Fechar";
        });
      });
    }

    // =========================
    // Concluídos (sidebar + modal)
    // =========================
    function updateConcluidosSidebar(currentRows){
      // conta concluídos usando status_execucao/situacao_execucao/andamento (sem arquivados já, porque currentRows é base do painel)
      const concluidosRows = currentRows.filter(r => {
        const exec = String(getFirst(r, [
          "status_execucao",
          "status_execução",
          "situacao_execucao",
          "situação_execução",
          "andamento",
          "execucao",
          "execução"
        ]) || "").toUpperCase();

        return exec.includes("CONCL") || exec.includes("FINALIZ");
      });

      kpi_concl_sidebar.textContent = concluidosRows.length;

      // prepara lista de instituições (únicas)
      const insts = Array.from(new Set(
        concluidosRows
          .map(r => String(getFirst(r, ["instituicao_parceira","instituicao","instituicao_parceira_nome"]) || "").trim())
          .filter(Boolean)
      )).sort((a,b)=>a.localeCompare(b, "pt-BR"));

      // guarda no botão (sem inventar estado global a mais)
      btn_ver_concl_insts.dataset.insts = JSON.stringify(insts);
    }

    function openModalWithInstitutions(insts){
      if(!insts || !insts.length){
        modalBody.innerHTML = `<div class="muted">—</div>`;
      } else {
        modalBody.innerHTML = `<ul>${insts.map(i=>`<li>${escapeHTML(i)}</li>`).join("")}</ul>`;
      }
      modalBackdrop.style.display = "flex";
    }

    btn_ver_concl_insts.addEventListener("click", ()=>{
      const insts = JSON.parse(btn_ver_concl_insts.dataset.insts || "[]");
      openModalWithInstitutions(insts);
    });

    btnModalClose.addEventListener("click", ()=>{
      modalBackdrop.style.display = "none";
    });
    modalBackdrop.addEventListener("click", (e)=>{
      if(e.target === modalBackdrop) modalBackdrop.style.display = "none";
    });

    // =========================
    // Events
    // =========================
    [f_ano, f_tipo, f_inst, f_uf, f_status].forEach(el => el.addEventListener("change", applyFilters));
    search.addEventListener("input", ()=>{ applyFilters(); });

    btn_ver_todos.addEventListener("click", ()=>{
      f_ano.value="__ALL__";
      f_tipo.value="__ALL__";
      f_inst.value="__ALL__";
      f_uf.value="__ALL__";
      f_status.value="__ALL__";
      search.value="";
      applyFilters();
    });

    // =========================
    // Init
    // =========================
    (async function init(){
      ALL = await loadCSV();

      // base SEM ARQUIVADOS (painel ignora)
      const base = ALL.filter(r => computeStatus(r) !== "ARQUIVADO");
      rebuildFilterOptions(base);

      // primeira renderização
      FILTERED = base;

      updateKPIs(base);
      buildStatusDonut(base);
      buildVencimentos(base);
      buildMapa(base);
      buildDiretorias(base);
      renderTable(base);
      updateConcluidosSidebar(base);
    })();
  </script>
</body>
</html>